!function(){var e={}.hasOwnProperty,t=function(t,n){function r(){this.constructor=t}for(var i in n)e.call(n,i)&&(t[i]=n[i]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t};this.Mercury.Regions.Markdown=function(e){function n(e,t,r){this.element=e,this.window=t,this.options=null!=r?r:{},n.__super__.constructor.apply(this,arguments),this.converter=new Showdown.converter}var r;return t(n,e),n.supported=document.getElementById,n.supportedText="Chrome 10+, Firefox 4+, IE 7+, Safari 5+, Opera 8+",r="markdown",n.prototype.type=function(){return r},n.prototype.build=function(){var e,t,n;return n="100%",e=this.element.height(),t=this.element.html().replace(/^\s+|\s+$/g,"").replace("&gt;",">"),this.textarea=jQuery("<textarea>",this.document).val(t).addClass("mercury-textarea"),this.textarea.css({border:0,background:"transparent",display:"block","overflow-y":"hidden",width:n,height:e,fontFamily:'"Courier New", Courier, monospace'}),this.element.empty().append(this.textarea),this.previewElement=jQuery("<div>",this.document),this.element.append(this.previewElement),this.container=this.element,this.container.data("region",this),this.element=this.textarea,this.resize()},n.prototype.dataAttributes=function(){var e,t,n,r,i;for(t={},i=Mercury.config.regions.dataAttributes,n=0,r=i.length;r>n;n++)e=i[n],t[e]=this.container.attr("data-"+e);return t},n.prototype.bindEvents=function(){var e=this;return Mercury.on("mode",function(t,n){return"preview"===n.mode?e.togglePreview():void 0}),Mercury.on("focus:frame",function(){return e.previewing||Mercury.region!==e?void 0:e.focus()}),Mercury.on("action",function(t,n){return e.previewing||Mercury.region!==e?void 0:n.action?e.execCommand(n.action,n):void 0}),Mercury.on("unfocus:regions",function(){return e.previewing||Mercury.region!==e?void 0:(e.element.blur(),e.container.removeClass("focus"),Mercury.trigger("region:blurred",{region:e}))}),this.element.on("dragenter",function(t){return e.previewing?void 0:(t.preventDefault(),t.originalEvent.dataTransfer.dropEffect="copy")}),this.element.on("dragover",function(t){return e.previewing?void 0:(t.preventDefault(),t.originalEvent.dataTransfer.dropEffect="copy")}),this.element.on("drop",function(t){return e.previewing?void 0:(Mercury.snippet&&(t.preventDefault(),e.focus(),Mercury.Snippet.displayOptionsFor(Mercury.snippet.name,{},Mercury.snippet.hasOptions)),t.originalEvent.dataTransfer.files.length?(t.preventDefault(),e.focus(),Mercury.uploader(t.originalEvent.dataTransfer.files[0])):void 0)}),this.element.on("focus",function(){return e.previewing?void 0:(Mercury.region=e,e.container.addClass("focus"),Mercury.trigger("region:focused",{region:e}))}),this.element.on("keydown",function(t){var n,r,i,s,o,a;if(!e.previewing){switch(e.resize(),t.keyCode){case 90:if(!t.metaKey)return;return t.preventDefault(),t.shiftKey?e.execCommand("redo"):e.execCommand("undo"),void 0;case 13:s=e.selection(),a=e.element.val(),o=a.lastIndexOf("\n",s.start),n=a.indexOf("\n",s.end),o>n&&(n=a.length),"\n"===a[o]&&(o=a.lastIndexOf("\n",s.start-1)),"-"===a[o+1]&&(s.replace("\n- ",!1,!0),t.preventDefault()),/\d/.test(a[o+1])&&(r=a.substring(o,n),/(\d+)\./.test(r)&&(i=parseInt(RegExp.$1),s.replace("\n"+(i+=1)+". ",!1,!0),t.preventDefault()));break;case 9:t.preventDefault(),e.execCommand("insertHTML",{value:"  "})}if(t.metaKey)switch(t.keyCode){case 66:e.execCommand("bold"),t.preventDefault();break;case 73:e.execCommand("italic"),t.preventDefault();break;case 85:e.execCommand("underline"),t.preventDefault()}return e.pushHistory(t.keyCode)}}),this.element.on("keyup",function(){return e.previewing?void 0:(Mercury.changes=!0,e.resize(),Mercury.trigger("region:update",{region:e}))}),this.element.on("mouseup",function(){return e.previewing?void 0:(e.focus(),Mercury.trigger("region:focused",{region:e}))}),this.previewElement.on("click",function(t){return e.previewing?$(t.target).closest("a").attr("target","_parent"):void 0})},n.prototype.focus=function(){return this.element.focus()},n.prototype.content=function(e,t){return null==e&&(e=null),null==t&&(t=!0),null!==e?"string"===jQuery.type(e)?this.element.val(e):(this.element.val(e.html),this.selection().select(e.selection.start,e.selection.end)):this.element.val()},n.prototype.contentAndSelection=function(){return{html:this.content(null,!1),selection:this.selection().serialize()}},n.prototype.togglePreview=function(){var e;return this.previewing?(this.previewing=!1,this.container.attr(Mercury.config.regions.attribute,r),this.previewElement.hide(),this.element.show(),Mercury.region===this?this.focus():void 0):(this.previewing=!0,this.container.removeAttr(Mercury.config.regions.attribute),e=this.converter.makeHtml(this.element.val()),this.previewElement.html(e),this.previewElement.show(),this.element.hide(),Mercury.trigger("region:blurred",{region:this}))},n.prototype.execCommand=function(e,t){var r;return null==t&&(t={}),n.__super__.execCommand.apply(this,arguments),(r=Mercury.Regions.Markdown.actions[e])&&r.call(this,this.selection(),t),this.resize()},n.prototype.pushHistory=function(e){var t,n,r,i=this;return t=[13,46,8],r=2.5,e&&(n=t.indexOf(e)),clearTimeout(this.historyTimeout),n>=0&&n!==this.lastKnownKeyCode?this.history.push(this.contentAndSelection()):e?this.historyTimeout=setTimeout(function(){return i.history.push(i.contentAndSelection())},1e3*r):this.history.push(this.contentAndSelection()),this.lastKnownKeyCode=n},n.prototype.selection=function(){return new Mercury.Regions.Markdown.Selection(this.element)},n.prototype.resize=function(){return this.element.css({height:this.element.get(0).scrollHeight-100}),this.element.css({height:this.element.get(0).scrollHeight})},n.prototype.snippets=function(){},n.actions={undo:function(){return this.content(this.history.undo())},redo:function(){return this.content(this.history.redo())},insertHTML:function(e,t){var n;return t.value.get&&(n=t.value.get(0))&&(t.value=jQuery("<div>").html(n).html()),e.replace(t.value,!1,!0)},insertImage:function(e,t){return e.replace("![add alt text]("+encodeURI(t.value.src)+")",!0)},insertTable:function(e,t){return e.replace(t.value.replace(/<br>|<br\/>/gi,""),!1,!0)},insertLink:function(e,t){return e.replace("["+t.value.content+"]("+t.value.attrs.href+" 'optional title')",!0)},insertUnorderedList:function(e){return e.addList("unordered")},insertOrderedList:function(e){return e.addList("ordered")},style:function(e,t){return e.wrap('<span class="'+t.value+'">',"</span>")},formatblock:function(e,t){var n,r,i;i={h1:["# "," #"],h2:["## "," ##"],h3:["### "," ###"],h4:["#### "," ####"],h5:["##### "," #####"],h6:["###### "," ######"],pre:["    ",""],blockquote:["> ",""],p:["\n","\n"]};for(r in i)n=i[r],e.unWrapLine(""+n[0],""+n[1]);return"blockquote"===t.value?(Mercury.Regions.Markdown.actions.indent.call(this,e,t),void 0):e.wrapLine(""+i[t.value][0],""+i[t.value][1])},bold:function(e){return e.wrap("**","**")},italic:function(e){return e.wrap("_","_")},subscript:function(e){return e.wrap("<sub>","</sub>")},superscript:function(e){return e.wrap("<sup>","</sup>")},indent:function(e){return e.wrapLine("> ","",!1,!0)},outdent:function(e){return e.unWrapLine("> ","",!1,!0)},horizontalRule:function(e){return e.replace("\n- - -\n")},insertSnippet:function(e,t){var n;return n=t.value,e.replace(n.getText())}},n}(Mercury.Region),Mercury.Regions.Markdown.Selection=function(){function e(e){this.element=e,this.el=this.element.get(0),this.getDetails()}return e.prototype.serialize=function(){return{start:this.start,end:this.end}},e.prototype.getDetails=function(){return this.length=this.el.selectionEnd-this.el.selectionStart,this.start=this.el.selectionStart,this.end=this.el.selectionEnd,this.text=this.element.val().substr(this.start,this.length)},e.prototype.replace=function(e,t,n){var r,i,s;return null==t&&(t=!1),null==n&&(n=!1),this.getDetails(),s=this.element.val(),i=this.element.val(),this.element.val(s.substr(0,this.start)+e+s.substr(this.end,s.length)),r=this.element.val()!==i,t&&this.select(this.start,this.start+e.length),n&&this.select(this.start+e.length,this.start+e.length),r},e.prototype.select=function(e,t){return this.start=e,this.end=t,this.element.focus(),this.el.selectionStart=this.start,this.el.selectionEnd=this.end,this.getDetails()},e.prototype.wrap=function(e,t){return this.getDetails(),this.deselectNewLines(),this.replace(e+this.text+t,""!==this.text),""===this.text?this.select(this.start+e.length,this.start+e.length):void 0},e.prototype.wrapLine=function(e,t,n,r){var i,s,o,a;return null==n&&(n=!0),null==r&&(r=!1),this.getDetails(),s=this.serialize(),a=this.element.val(),o=a.lastIndexOf("\n",this.start),i=a.indexOf("\n",this.end),o>i&&(i=a.length),"\n"===a[o]&&(o=a.lastIndexOf("\n",this.start-1)),this.select(o+1,i),this.replace(e+this.text+t,n),r?this.select(s.start+e.length,s.end+e.length):void 0},e.prototype.unWrapLine=function(e,t,n,r){var i,s,o,a,l,u,c;return null==n&&(n=!0),null==r&&(r=!1),this.getDetails(),l=this.serialize(),c=this.element.val(),u=c.lastIndexOf("\n",this.start),s=c.indexOf("\n",this.end),u>s&&(s=c.length),"\n"===c[u]&&(u=c.lastIndexOf("\n",this.start-1)),this.select(u+1,s),window.something=this.text,o=new RegExp("^"+e.regExpEscape()),a=new RegExp(""+t.regExpEscape()+"$"),i=this.replace(this.text.replace(o,"").replace(a,""),n),r&&i?this.select(l.start-e.length,l.end-e.length):void 0},e.prototype.addList=function(e){var t,n,r,i,s,o;return o=this.element.val(),s=o.lastIndexOf("\n",this.start),t=o.indexOf("\n",this.end),s>t&&(t=o.length),"\n"===o[s]&&(s=o.lastIndexOf("\n",this.start-1)),this.select(s+1,t),i=this.text.split("\n"),"unordered"===e?this.replace("- "+i.join("\n- "),!0):this.replace(function(){var e,t,s;for(s=[],n=e=0,t=i.length;t>e;n=++e)r=i[n],s.push(""+(n+1)+". "+r);return s}().join("\n"),!0)},e.prototype.deselectNewLines=function(){var e,t;return t=this.text,e=t.replace(/\n+$/g,"").length,this.select(this.start,this.start+e)},e.prototype.placeMarker=function(){return this.wrap("[mercury-marker]","[mercury-marker]")},e.prototype.removeMarker=function(){var e,t,n;return n=this.element.val(),t=n.indexOf("[mercury-marker]"),t>-1?(e=n.indexOf("[mercury-marker]",t+1)-"[mercury-marker]".length,this.element.val(this.element.val().replace(/\[mercury-marker\]/g,"")),this.select(t,e)):void 0},e.prototype.textContent=function(){return this.text},e}()}.call(this);