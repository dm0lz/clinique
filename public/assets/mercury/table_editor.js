!function(){this.Mercury.tableEditor=function(t,e,r){return Mercury.tableEditor.load(t,e,r),Mercury.tableEditor},jQuery.extend(Mercury.tableEditor,{load:function(t,e,r){return this.table=t,this.cell=e,this.cellContent=null!=r?r:"",this.row=this.cell.parent("tr"),this.columnCount=this.getColumnCount(),this.rowCount=this.getRowCount()},addColumnBefore:function(){return this.addColumn("before")},addColumnAfter:function(){return this.addColumn("after")},addColumn:function(t){var e,r,o,n,i,l,s,h,a,f,c,u;for(null==t&&(t="after"),h=this.cellSignatureFor(this.cell),c=this.table.find("tr"),u=[],e=a=0,f=c.length;f>a;e=++a)l=c[e],s=1,o="after"===t?{right:h.right}:{left:h.left},(n=this.findCellByOptionsFor(l,o))?(i=jQuery("<"+n.cell.get(0).tagName+">").html(this.cellContent),this.setRowspanFor(i,n.height),"before"===t?n.cell.before(i):n.cell.after(i),u.push(e+=n.height-1)):(r=this.findCellByIntersectionFor(l,h))?u.push(this.setColspanFor(r.cell,r.width+1)):u.push(void 0);return u},removeColumn:function(){var t,e,r,o,n,i,l,s,h,a,f,c,u,d,p,F;if(s=this.cellSignatureFor(this.cell),!(s.width>1)){for(i=[],t=[],p=this.table.find("tr"),r=h=0,c=p.length;c>h;r=++h)l=p[r],(n=this.findCellByOptionsFor(l,{left:s.left,width:s.width}))?(i.push(n.cell),r+=n.height-1):(o=this.findCellByIntersectionFor(l,s))&&t.push(o.cell);for(a=0,u=i.length;u>a;a++)e=i[a],jQuery(e).remove();for(F=[],f=0,d=t.length;d>f;f++)e=t[f],F.push(this.setColspanFor(e,this.colspanFor(e)-1));return F}},addRowBefore:function(){return this.addRow("before")},addRowAfter:function(){return this.addRow("after")},addRow:function(t){var e,r,o,n,i,l,s,h,a,f,c,u,d,p,F,w,g;for(null==t&&(t="after"),i=jQuery("<tr>"),(h=this.rowspanFor(this.cell))>1&&"after"===t&&(this.row=jQuery(this.row.nextAll("tr")[h-2])),r=0,F=this.row.find("th, td"),a=0,u=F.length;u>a;a++)e=F[a],o=this.colspanFor(e),n=jQuery("<"+e.tagName+">").html(this.cellContent),this.setColspanFor(n,o),r+=o,(h=this.rowspanFor(e))>1&&"after"===t?this.setRowspanFor(e,h+1):i.append(n);if(r<this.columnCount)for(s=0,w=this.row.prevAll("tr"),f=0,d=w.length;d>f;f++)for(l=w[f],s+=1,g=jQuery(l).find("td[rowspan], th[rowspan]"),c=0,p=g.length;p>c;c++)e=g[c],h=this.rowspanFor(e),h-1>=s&&"before"===t?this.setRowspanFor(e,h+1):h-1>=s&&"after"===t&&(h-1===s?(n=jQuery("<"+e.tagName+">").html(this.cellContent),this.setColspanFor(n,this.colspanFor(e)),i.append(n)):this.setRowspanFor(e,h+1));return"before"===t?this.row.before(i):this.row.after(i)},removeRow:function(){var t,e,r,o,n,i,l,s,h,a,f,c,u,d,p,F,w,g,C,y,m,v,j,Q;for(h=!0,i=0,n=0,y=this.row.find("td, th"),f=0,p=y.length;p>f;f++)e=y[f],s=this.rowspanFor(e),i&&s!==i&&(h=!1),(n>s||!n)&&(n=s),i=s;if(h||!(this.rowspanFor(this.cell)>n)){if(n>1)for(r=c=0,m=n-2;m>=0?m>=c:c>=m;r=m>=0?++c:--c)jQuery(this.row.nextAll("tr")[r]).remove();for(v=this.row.find("td[rowspan], th[rowspan]"),u=0,F=v.length;F>u;u++)e=v[u],a=this.cellSignatureFor(e),a.height!==n&&(o=this.findCellByOptionsFor(this.row.nextAll("tr")[n-1],{left:a.left,forceAdjacent:!0}))&&(this.setRowspanFor(e,this.rowspanFor(e)-this.rowspanFor(this.cell)),"before"===o.direction?o.cell.before(jQuery(e).clone()):o.cell.after(jQuery(e).clone()));if(this.columnsFor(this.row.find("td, th"))<this.columnCount)for(l=0,j=this.row.prevAll("tr"),d=0,w=j.length;w>d;d++)for(t=j[d],l+=1,Q=jQuery(t).find("td[rowspan], th[rowspan]"),C=0,g=Q.length;g>C;C++)e=Q[C],s=this.rowspanFor(e),s>l&&this.setRowspanFor(e,s-this.rowspanFor(this.cell));return this.row.remove()}},increaseColspan:function(){var t;return t=this.cell.next("td, th"),!t.length||this.rowspanFor(t)!==this.rowspanFor(this.cell)||this.cellIndexFor(t)>this.cellIndexFor(this.cell)+this.colspanFor(this.cell)?void 0:(this.setColspanFor(this.cell,this.colspanFor(this.cell)+this.colspanFor(t)),t.remove())},decreaseColspan:function(){var t;if(1!==this.colspanFor(this.cell))return this.setColspanFor(this.cell,this.colspanFor(this.cell)-1),t=jQuery("<"+this.cell.get(0).tagName+">").html(this.cellContent),this.setRowspanFor(t,this.rowspanFor(this.cell)),this.cell.after(t)},increaseRowspan:function(){var t,e,r;return r=this.cellSignatureFor(this.cell),e=this.row.nextAll("tr")[r.height-1],e&&(t=this.findCellByOptionsFor(e,{left:r.left,width:r.width}))?(this.setRowspanFor(this.cell,r.height+t.height),t.cell.remove()):void 0},decreaseRowspan:function(){var t,e,r,o;return o=this.cellSignatureFor(this.cell),1!==o.height?(r=this.row.nextAll("tr")[o.height-2],(t=this.findCellByOptionsFor(r,{left:o.left,forceAdjacent:!0}))?(e=jQuery("<"+this.cell.get(0).tagName+">").html(this.cellContent),this.setColspanFor(e,this.colspanFor(this.cell)),this.setRowspanFor(this.cell,o.height-1),"before"===t.direction?t.cell.before(e):t.cell.after(e)):void 0):void 0},getColumnCount:function(){return this.columnsFor(this.table.find("thead tr:first-child, tbody tr:first-child, tfoot tr:first-child").first().find("td, th"))},getRowCount:function(){return this.table.find("tr").length},cellIndexFor:function(t){var e,r,o,n,i,l,s,h,a,f,c,u;if(t=jQuery(t),i=t.parent("tr"),o=this.columnsFor(i.find("td, th")),n=this.columnsFor(t.prevAll("td, th")),o<this.columnCount)for(l=0,c=i.prevAll("tr"),s=0,a=c.length;a>s;s++)for(r=c[s],l+=1,u=jQuery(r).find("td[rowspan], th[rowspan]"),h=0,f=u.length;f>h;h++)e=u[h],this.rowspanFor(e)>l&&this.cellIndexFor(e)<=n&&(n+=this.colspanFor(e));return n},cellSignatureFor:function(t){var e;return e={cell:jQuery(t)},e.left=this.cellIndexFor(t),e.width=this.colspanFor(t),e.height=this.rowspanFor(t),e.right=e.left+e.width,e},findCellByOptionsFor:function(t,e){var r,o,n,i,l,s;for(s=jQuery(t).find("td, th"),i=0,l=s.length;l>i;i++){if(r=s[i],n=this.cellSignatureFor(r),"undefined"!=typeof e.right&&n.right===e.right)return n;if("undefined"!=typeof e.left)if(e.width){if(n.left===e.left&&n.width===e.width)return n}else if(e.forceAdjacent){if(e.forceAdjacent&&n.left>e.left)return o=jQuery(r).prev("td, th"),o.length?(n=this.cellSignatureFor(o),n.direction="after"):n.direction="before",n}else if(n.left===e.left)return n}return e.forceAdjacent?(n.direction="after",n):null},findCellByIntersectionFor:function(t,e){var r,o,n,i,l;for(l=jQuery(t).find("td, th"),n=0,i=l.length;i>n;n++)if(r=l[n],o=this.cellSignatureFor(r),o.right-e.left>=0&&o.right>e.left)return o;return null},columnsFor:function(t){var e,r,o,n;for(r=0,o=0,n=t.length;n>o;o++)e=t[o],r+=this.colspanFor(e);return r},colspanFor:function(t){return parseInt(jQuery(t).attr("colspan"))||1},rowspanFor:function(t){return parseInt(jQuery(t).attr("rowspan"))||1},setColspanFor:function(t,e){return jQuery(t).attr("colspan",e>1?e:null)},setRowspanFor:function(t,e){return jQuery(t).attr("rowspan",e>1?e:null)}})}.call(this);