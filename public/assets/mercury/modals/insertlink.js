!function(){this.Mercury.modalHandlers.insertLink={initialize:function(){var e=this;return this.editing=!1,this.content=null,this.element.find(".control-label input").on("click",this.onLabelChecked),this.element.find(".controls .optional, .controls .required").on("focus",this.onInputFocused),this.element.find("#link_target").on("change",function(){return e.onChangeTarget()}),this.initializeForm(),this.element.find("form").on("submit",function(t){return t.preventDefault(),e.validateForm(),e.valid?(e.submitForm(),e.hide()):(e.resize(),void 0)})},initializeForm:function(){var e,t,n,i,r,o;return this.fillExistingBookmarks(),Mercury.region&&Mercury.region.selection?(o=Mercury.region.selection(),o.textContent&&this.element.find("#link_text").val(o.textContent()),o&&o.commonAncestor&&(e=o.commonAncestor(!0).closest("a")),o.htmlContent&&(i=/<img/.test(o.htmlContent())),i||e&&e.length?(this.element.find("#link_text_container").hide(),i&&(this.content=o.htmlContent()),e&&e.length?(this.editing=e,e.attr("href")&&0===e.attr("href").indexOf("#")?(t=this.element.find("#link_existing_bookmark"),t.val(e.attr("href").replace(/[^#]*#/,"")),t.closest(".control-group").find("input[type=radio]").prop("checked",!0)):this.element.find("#link_external_url").val(e.attr("href")),e.attr("name")&&(r=this.element.find("#link_new_bookmark"),r.val(e.attr("name")),r.closest(".control-group").find("input[type=radio]").prop("checked",!0)),e.attr("target")&&this.element.find("#link_target").val(e.attr("target")),e.attr("href")&&0===e.attr("href").indexOf("javascript:void")?(n=e.attr("href"),this.element.find("#link_external_url").val(n.match(/window.open\('([^']+)',/)[1]),this.element.find("#link_target").val("popup"),this.element.find("#link_popup_width").val(n.match(/width=(\d+),/)[1]),this.element.find("#link_popup_height").val(n.match(/height=(\d+),/)[1]),this.element.find("#popup_options").show()):void 0):!1):!1):void 0},fillExistingBookmarks:function(){var e,t,n,i,r,o;for(e=this.element.find("#link_existing_bookmark"),r=jQuery("a[name]",window.mercuryInstance.document),o=[],n=0,i=r.length;i>n;n++)t=r[n],o.push(e.append(jQuery("<option>",{value:jQuery(t).attr("name")}).text(jQuery(t).text())));return o},onLabelChecked:function(){var e;return e=jQuery(this).closest(".control-label").attr("for"),jQuery(this).closest(".control-group").find("#"+e).focus()},onInputFocused:function(){return jQuery(this).closest(".control-group").find("input[type=radio]").prop("checked",!0)},onChangeTarget:function(){return this.element.find(".link-target-options").hide(),this.element.find("#"+this.element.find("#link_target").val()+"_options").show(),this.resize(!0)},addInputError:function(e,t){return e.after('<span class="help-inline error-message">'+Mercury.I18n(t)+"</span>").closest(".control-group").addClass("error"),this.valid=!1},clearInputErrors:function(){return this.element.find(".control-group.error").removeClass("error").find(".error-message").remove(),this.valid=!0},validateForm:function(){var e,t;return this.clearInputErrors(),t=this.element.find("input[name=link_type]:checked").val(),e=this.element.find("#link_"+t),e.val()||this.addInputError(e,"can't be blank"),this.editing||this.content||(e=this.element.find("#link_text"),e.val())?void 0:this.addInputError(e,"can't be blank")},submitForm:function(){var e,t,n,i,r,o;switch(n=this.element.find("#link_text").val(),i=this.element.find("#link_target").val(),r=this.element.find("input[name=link_type]:checked").val()){case"existing_bookmark":t={href:"#"+this.element.find("#link_existing_bookmark").val()};break;case"new_bookmark":t={name:""+this.element.find("#link_new_bookmark").val()};break;default:t={href:this.element.find("#link_"+r).val()}}switch(i){case"popup":e={width:parseInt(this.element.find("#link_popup_width").val())||500,height:parseInt(this.element.find("#link_popup_height").val())||500,menubar:"no",toolbar:"no"},t.href="javascript:void(window.open('"+t.href+"', 'popup_window', '"+jQuery.param(e).replace(/&/g,",")+"'))";break;default:i&&(t.target=i)}return o={tagName:"a",attrs:t,content:this.content||n},this.editing?Mercury.trigger("action",{action:"replaceLink",value:o,node:this.editing.get(0)}):Mercury.trigger("action",{action:"insertLink",value:o})}}}.call(this);